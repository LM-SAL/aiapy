image: python:3.10

before_script:
  - pip install tox

stages:
  - Basic
  - Test
  - Extra
  - Deploy

codestyle:
  stage: Basic
  script:
    - tox -e codestyle

py310:
  stage: Basic
  script:
    - tox -e py310

py310-online:
  stage: Test
  script:
    - tox -e py310-online
    - pip install --upgrade codecov
    - codecov

py38:
  stage: Test
  image: python:3.8
  script:
    - tox -e py38

py39-devdeps:
  allow_failure: true
  stage: Extra
  image: python:3.9
  script:
    - tox -e py39-devdeps

build_docs:
  stage: Extra
  image: python:3.9
  before_script:
    # Need graphviz binary for generating inheritance diagrams
    - apt-get update -qq && apt-get install -y -qq graphviz
    - pip install tox
  script:
    - tox -e build_docs

pypi:
  stage: Deploy
  rules:
      # Only match vX.Y.Z and noting with dev in it
      - if: $CI_COMMIT_TAG  =~ /v\d+.\d+.\d+(\?\!dev)/
  before_script:
    - pip install --upgrade twine pep517
  script:
    - python -m pep517.build --source --out-dir dist .
    - twine upload dist/aiapy*.tar.gz
